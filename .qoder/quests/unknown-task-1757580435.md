# Дизайн: Редактирование и отображение осей и отметок в журнале производства работ

## Обзор

Этот документ описывает реализацию функциональности для редактирования и отображения полей "axes" (оси) и "marks" (отметки) в журнале производства работ, а также их экспорт в Excel после наименования работ.

## Архитектура

### Текущая структура данных
В файле `journal_production.json` уже существуют поля "axes" и "marks" в записях:
```json
{
  "date": "2025-09-04",
  "name": "Штукатурка стен",
  "axes": "1",
  "marks": "+1",
  "volume": 10.0,
  "volume_unit": "м²",
  ...
}
```

### Компоненты системы
1. **OZR.py** - Редактор журналов производства работ
2. **ZVK.py** - Редактор журналов входного контроля
3. **upload.py** - Экспорт в Excel/Word

## Реализация функциональности

### 1. Обновление таблицы отображения в OZR.py

#### Добавление новых столбцов
Необходимо добавить столбцы "Оси" и "Отметки" в таблицу отображения журнала производства работ.

Изменения в `OZR.py`:
- Добавить новые столбцы в `self.columns`
- Обновить `self.column_keys` для соответствия новым полям
- Добавить новые столбцы в `self.editable_columns`
- Обновить ширину столбцов в `column_widths`

#### Обновление функции отображения
В функции `update_treeview()` добавить отображение значений axes и marks в соответствующих столбцах.

### 2. Обновление редактирования в OZR.py

#### Добавление возможности редактирования
Поскольку поля "axes" и "marks" уже существуют в данных, необходимо:
- Добавить эти поля в список редактируемых столбцов
- Обеспечить сохранение изменений в JSON файле

### 3. Обновление экспорта в Excel

#### Модификация функции export_to_excel()
В файле `OZR.py` необходимо обновить функцию экспорта в Excel:
- Добавить новые столбцы "Оси" и "Отметки" в заголовки
- Включить значения axes и marks в экспортируемые данные
- Расположить столбцы после "Наименование работ" как запрашивалось

### 4. Возможные изменения в ZVK.py

Хотя в журнале входного контроля поля "axes" и "marks" присутствуют, но установлены в null, может потребоваться:
- Добавить отображение этих полей в таблицу
- Добавить возможность редактирования
- Включить в экспорт в Excel

## Модель данных

### journal_production.json
```json
{
  "entries": [
    {
      "date": "string",
      "name": "string",
      "axes": "string", 
      "marks": "string",
      "volume": "number",
      "volume_unit": "string",
      ...
    }
  ]
}
```

### journal_incoming.json
```json
{
  "entries": [
    {
      "date": "string",
      "name": "string",
      "axes": "string", 
      "marks": "string",
      ...
    }
  ]
}
```

## Пользовательский интерфейс

### Таблица журнала производства работ
```
| Подрядчик | Дата | Наименование работ | Оси | Отметки | Объем | Ед. изм. | ... |
|-----------|------|--------------------|-----|---------|-------|----------|-----|
| ООО Строй | 2025-09-04 | Штукатурка стен | 1 | +1 | 10.0 | м² | ... |
```

### Редактирование
- Двойной клик по ячейке "Оси" или "Отметки" для редактирования
- Поддержка сохранения изменений в JSON файл

## Экспорт в Excel

### Структура Excel файла
```
| Дата | Наименование работ | Оси | Отметки | Объем | Единица измерения | ... |
|------|--------------------|-----|---------|-------|-------------------|-----|
| 2025-09-04 | Штукатурка стен | 1 | +1 | 10.0 | м² | ... |
```

## Тестирование

### Unit тесты
1. Проверка загрузки данных с полями axes и marks
2. Проверка отображения полей в таблице
3. Проверка редактирования полей
4. Проверка сохранения изменений в JSON
5. Проверка экспорта в Excel с новыми полями

### Интеграционные тесты
1. Полный цикл: редактирование → сохранение → экспорт в Excel
2. Проверка корректности отображения данных в Excel

## Детали реализации

### Изменения в OZR.py

#### 1. Обновление метода create_treeview

```python
# Столбцы таблицы
self.columns = ("Подрядчик", "Дата", "Наименование работ", "Оси", "Отметки", "Объем", "Ед. изм.",
                "Фото", "Исполнитель", "Создано")

# Соответствие столбцов ключам в данных
self.column_keys = {
    "Подрядчик": "contractor",
    "Дата": "date",
    "Наименование работ": "name",
    "Оси": "axes",
    "Отметки": "marks",
    "Объем": "volume",
    "Ед. изм.": "volume_unit",
    "Фото": "photos",
    "Исполнитель": "filled_by",
    "Создано": "created_at"
}

# Редактируемые столбцы
self.editable_columns = {"Дата", "Наименование работ", "Оси", "Отметки", "Объем", "Ед. изм.", "Исполнитель"}

# Настройка ширины столбцов
column_widths = [120, 100, 250, 80, 80, 80, 80, 80, 150, 150]
```

#### 2. Обновление метода update_treeview

```python
# Заполняем таблицы данными
for i, entry in enumerate(self.data):
    photo_text = f"{len(entry.get('photos', []))} фото" if entry.get('photos') else "Нет"
    values = (
        entry.get('contractor', ''),
        entry.get('date', ''),
        entry.get('name', ''),
        entry.get('axes', ''),
        entry.get('marks', ''),
        entry.get('volume', ''),
        entry.get('volume_unit', ''),
        photo_text,
        entry.get('filled_by', ''),
        entry.get('created_at', '')
    )
    self.tree.insert('', 'end', iid=str(i), values=values)
```

#### 3. Обновление метода export_to_excel

```python
# Заголовки столбцов
headers = [
    "Дата", "Наименование работ", "Оси", "Отметки", "Объем", "Единица измерения",
    "Исполнитель", "Подрядчик", "Количество фото", "Создано"
]

# Записываем данные
for entry in sorted_data:
    date_value = entry.get('date', '')
    name_value = entry.get('name', '')
    axes_value = entry.get('axes', '')
    marks_value = entry.get('marks', '')
    volume_value = entry.get('volume', '')
    unit_value = entry.get('volume_unit', '')
    executor_value = entry.get('filled_by', '')
    contractor_value = entry.get('contractor', '')
    photos_count = len(entry.get('photos', []))
    created_value = entry.get('created_at', '')
    
    row_data = [
        date_value,
        name_value,
        axes_value,
        marks_value,
        volume_value,
        unit_value,
        executor_value,
        contractor_value,
        photos_count if photos_count > 0 else "",
        created_value
    ]
```

### Изменения в ZVK.py (опционально)

Если потребуется добавить поддержку осей и отметок в журнал входного контроля:

#### 1. Обновление метода create_treeview

```python
# Столбцы таблицы
self.columns = ("Подрядчик", "Дата", "Наименование материала", "Оси", "Отметки", "Количество", "Ед. изм.",
                "Поставщик", "Документ", "Проверка кач.", "Файлы", "Лаб. контроль", "Результат лаб.",
                "Исполнитель", "Создано")

# Соответствие столбцов ключам в данных
self.column_keys = {
    "Подрядчик": "contractor",
    "Дата": "date",
    "Наименование материала": "name",
    "Оси": "axes",
    "Отметки": "marks",
    "Количество": "quantity",
    "Ед. изм.": "quantity_unit",
    "Поставщик": "supplier",
    "Документ": "document",
    "Проверка кач.": "document_check_result",
    "Файлы": "document_files",
    "Лаб. контроль": "lab_control_needed",
    "Результат лаб.": "lab_control_result",
    "Исполнитель": "filled_by",
    "Создано": "created_at"
}

# Редактируемые столбцы
self.editable_columns = {"Дата", "Наименование материала", "Оси", "Отметки", "Количество", "Ед. изм.",
                         "Поставщик", "Документ", "Проверка кач.", "Лаб. контроль", "Результат лаб.",
                         "Исполнитель"}
```

#### 2. Обновление метода update_treeview

```python
# Заполняем таблицы данными
for i, entry in enumerate(self.data):
    # Формируем отображение количества
    quantity_display = ""
    if isinstance(entry.get('quantity'), (int, float)):
        quantity_display = str(entry.get('quantity', ''))
    else:
        quantity_display = entry.get('quantity', '')

    # Количество файлов документов
    doc_files = entry.get('document_files', [])
    files_text = f"{len(doc_files)} файл(ов)" if doc_files else "Нет"

    # Лабораторный контроль
    lab_control = "Да" if entry.get('lab_control_needed', False) else "Нет"

    # Добавляем значение проверки документов
    doc_check = entry.get('document_check_result', '')

    values = (
        entry.get('contractor', ''),
        entry.get('date', ''),
        entry.get('name', ''),
        entry.get('axes', ''),
        entry.get('marks', ''),
        quantity_display,
        entry.get('quantity_unit', ''),
        entry.get('supplier', ''),
        entry.get('document', ''),
        doc_check,
        files_text,
        lab_control,
        entry.get('lab_control_result', ''),
        entry.get('filled_by', ''),
        entry.get('created_at', '')
    )
    self.tree.insert('', 'end', iid=str(i), values=values)
```

#### 3. Обновление метода export_to_excel

Аналогично обновлению в OZR.py, добавить столбцы "Оси" и "Отметки" в экспорт Excel.

## Безопасность и валидация

1. Проверка корректности ввода для полей осей и отметок
2. Обработка пустых значений
3. Обеспечение совместимости с существующими данными
4. Валидация при сохранении в JSON файлы

## Производительность

1. Оптимизация загрузки данных при большом количестве записей
2. Эффективная сортировка по полям осей и отметок
3. Минимизация операций чтения/записи файлов

## Совместимость

1. Поддержка существующих файлов journal_production.json без потери данных
2. Обратная совместимость с предыдущими версиями приложения
3. Корректная работа с пустыми значениями полей axes и marks

## Локализация

1. Отображение названий столбцов на русском языке
2. Поддержка кириллических символов в полях осей и отметок
3. Локализованные сообщения об ошибках